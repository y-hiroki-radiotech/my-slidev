---
description: PDF出力用にスライドを最適化する（背景色変更、文字色調整、レイアウト確認、エクスポート実行）
---

# PDF出力用最適化 (完全自動実行モード)

**重要:** このワークフローは、ユーザーの介入なしに、開始から完了まで完全に自動で実行されるように設計されています。各ステップは完了後、ただちに次のステップへ移行してください。思考の途中でユーザーに確認を求めたり、作業を中断したりしないでください。

**引数:** なし（現在のslides.mdを対象とする） または スライドファイルパス (例: `/prepare-pdf` または `/prepare-pdf pages/abstract-Smith-2024.md`)

**オプション引数:**
- `--skip-backup`: バックアップをスキップ（通常は推奨されない）
- `--export-only`: 最適化をスキップし、PDF出力のみ実行
- `--theme [theme-name]`: 特定のテーマを使用（デフォルト: default）

---

## ステップ1: 準備とコンテキスト設定

1. 現在のタスクコンテキストを確立する:
  - 対象ファイル: `[引数で指定されたファイル、またはslides.md]`
  - 日付: `[現在の日付をYYYYMMDD形式で取得]`
  - プランニングディレクトリパス: `.pdf-planning/[日付]-[ファイル名]/`
2. 上記プランニングディレクトリを作成する。
3. 以下のファイルを作成する:
  - `[プランニングディレクトリパス]/optimization-checklist.md` (最適化チェックリスト)
  - `[プランニングディレクトリパス]/changes-log.md` (変更履歴)
  - `[プランニングディレクトリパス]/tasklist.md` (タスクリスト)

## ステップ2: プロジェクト理解

1. `CLAUDE.md`を読み、PDF出力に関するルールを確認する:
  - "PDF用のスライドは背景を白に変更し、それに伴って文字の色も調整すること"

2. 対象スライドファイルを読み込み、現在の状態を把握する:
  - フロントマターの設定
  - 背景色の設定
  - テーマの設定
  - 文字色の使用状況
  - 画像・アイコンの使用状況
  - レイアウトの複雑さ

## ステップ3: バックアップの作成

1. `--skip-backup`オプションが指定されていない場合、以下を実行:

2. git commitを実行して、現在の状態をバックアップする:
  ```bash
  git add [対象ファイル]
  git commit -m "Backup before PDF optimization: [ファイル名]"
  ```

3. バックアップファイルを作成する:
  - `[対象ファイル].backup-[日付]`にコピーを保存

4. バックアップ完了をログに記録:
  ```markdown
  # バックアップ情報

  - 元ファイル: [対象ファイル]
  - バックアップファイル: [対象ファイル].backup-[日付]
  - Git commit: [commit hash]
  - 作成日時: [日時]
  ```

**このステップが正常に完了したら、決して停止せず、ただちにステップ4に進むこと。**

## ステップ4: 最適化計画の作成

1. `--export-only`オプションが指定されている場合、このステップをスキップしてステップ7に進む。

2. 対象ファイルの内容を分析し、`optimization-checklist.md`に最適化項目をリストアップする:
  ```markdown
  # PDF出力用最適化チェックリスト

  ## フロントマター最適化
  - [ ] themeを'default'に変更（PDF出力に最適）
  - [ ] backgroundを'white'に変更
  - [ ] class設定を確認（必要に応じて調整）
  - [ ] highlighterの設定確認
  - [ ] transitionの設定確認（PDFでは無効だが整理）

  ## 文字色の最適化
  - [ ] ダークテーマ用の明るい文字色を削除・調整
  - [ ] text-white → text-black または text-gray-900
  - [ ] text-gray-xxx（明るい色）→ text-gray-xxx（暗い色）
  - [ ] カスタムカラークラスの確認と調整

  ## 背景色の最適化
  - [ ] bg-dark系のクラスを削除・調整
  - [ ] bg-gray-xxx（暗い色）→ bg-gray-xxx（明るい色）またはbg-white
  - [ ] カスタム背景色の調整

  ## アイコン・画像の最適化
  - [ ] アイコンの色を調整（明るい色 → 暗い色）
  - [ ] text-white、text-yellow-500などのアイコン色をtext-gray-700などに変更
  - [ ] 画像の周囲の背景色を確認
  - [ ] 画像のコントラストを確認

  ## レイアウトの最適化
  - [ ] grid/flexレイアウトの背景色を確認
  - [ ] ボーダー色の調整（暗い背景用 → 明るい背景用）
  - [ ] カードやボックスの背景・ボーダーを調整
  - [ ] シャドウ効果の確認（PDF出力での見え方）

  ## コードブロックの最適化
  - [ ] コードブロックの背景色を確認
  - [ ] コードのシンタックスハイライトテーマを確認
  - [ ] highlighterがPDF出力に対応しているか確認

  ## その他の要素
  - [ ] リンクの色を調整（visibility確保）
  - [ ] ボタンやインタラクティブ要素の色を調整
  - [ ] 表（table）の枠線と背景色を調整
  - [ ] 引用（blockquote）のスタイルを調整

  ## 印刷品質の確認
  - [ ] 文字サイズが適切か（28pt以上を基本）
  - [ ] コントラスト比が十分か（WCAG基準）
  - [ ] 印刷時に重要な情報が失われないか
  ```

3. `tasklist.md`に実装タスクを作成:
  ```markdown
  # PDF最適化タスクリスト

  ## フロントマター変更
  - [ ] theme設定の変更
  - [ ] background設定の変更
  - [ ] その他フロントマター項目の調整

  ## スライド本体の最適化
  - [ ] 文字色の一括置換（text-white → text-black）
  - [ ] 文字色の個別調整（コンテキストに応じて）
  - [ ] 背景色の調整
  - [ ] アイコン色の調整
  - [ ] レイアウト要素の背景・ボーダー調整
  - [ ] コードブロックの調整
  - [ ] その他の要素の調整

  ## 検証
  - [ ] プレビュー確認（変更後の見た目）
  - [ ] コントラスト比の確認
  - [ ] 印刷プレビューの確認

  ## PDF出力
  - [ ] slidev exportコマンドの実行
  - [ ] 生成されたPDFの確認
  - [ ] ページ数の確認
  - [ ] 品質の確認

  ## 完了処理
  - [ ] 変更ログの記録
  - [ ] git commit
  ```

**このステップが正常に完了したら、決して停止せず、ただちにステップ5に進むこと。**

## ステップ5: 実装ループ (最適化作業の完全消化)

**このステップは、`tasklist.md`の全タスクが `[x]` になるまで自動で繰り返されるループ処理です。**
**このステップが正常に完了したら、決して停止せず、ただちにステップ6に進むこと。**

**ループ開始:**

1. タスクリストの読み込み:
  - `[プランニングディレクトリパス]/tasklist.md`ファイルを読み込む。

2. 進捗の確認:
  - ファイル内に未完了タスク (`[ ]`) が存在するか確認する。
  - **もし未完了タスクが存在しない場合:** この実装ループは完了とみなし、ただちに**ステップ6**へ進む。
  - **もし未完了タスクが存在する場合:** 次の処理（3. タスクの実行）に進む。

3. タスクの実行:
  - `tasklist.md`の**先頭にある未完了タスク**を1つ特定する。
  - そのタスクを完了させるために必要な最適化作業を実行する。
  - 以下のルールを厳守する:

    **フロントマター変更の例:**
    ```yaml
    変更前:
    ---
    theme: seriph
    background: https://source.unsplash.com/...
    class: text-center
    ---

    変更後:
    ---
    theme: default
    background: white
    class: text-center
    ---
    ```

    **文字色の変更パターン:**
    - `text-white` → `text-black` または `text-gray-900`
    - `text-gray-100` → `text-gray-900`
    - `text-gray-200` → `text-gray-800`
    - `text-blue-400` → `text-blue-700`
    - `text-yellow-400` → `text-yellow-700`

    **背景色の変更パターン:**
    - `bg-gray-800` → `bg-gray-100` または `bg-white`
    - `bg-gray-900` → `bg-gray-50`
    - `bg-blue-800` → `bg-blue-50`

    **アイコン色の変更例:**
    ```markdown
    変更前:
    <mdi-radioactive class="text-4xl text-yellow-500" />

    変更後:
    <mdi-radioactive class="text-4xl text-yellow-700" />
    ```

    **レイアウト要素の調整例:**
    ```markdown
    変更前:
    <div class="bg-gray-800 text-white p-4 rounded">
      内容
    </div>

    変更後:
    <div class="bg-gray-50 text-black p-4 rounded border border-gray-300">
      内容
    </div>
    ```

4. 変更内容を`changes-log.md`に記録する:
  ```markdown
  ## 変更 #[番号] - [日時]

  ### 対象
  - ファイル: [ファイル名]
  - 行番号: [行番号範囲]

  ### 変更内容
  - 変更前: [変更前のコード]
  - 変更後: [変更後のコード]

  ### 理由
  - [変更理由の説明]
  ```

5. タスクリストの更新:
  - 実行したタスクが完了したら、`Edit`ツールを使用して`tasklist.md`を更新し、該当タスクを `[ ]` から `[x]` に変更する。

6. ループ継続:
  - **ステップ5の先頭 (1. タスクリストの読み込み) に戻り、処理を繰り返す。**

---
### ※ 実装ループ内の例外処理ルール ※

実装ループの実行中に以下の状況が発生した場合は、このルールに従って自律的に対処し、ループを継続すること。

- **ルールA: タスクが大きすぎる場合**
  - **対処法:** 現在のタスクをより小さな複数のサブタスクに分割する。`Edit`ツールを使い、元のタスクを削除し、その場所に新しいサブタスク（`[ ]`付き）を挿入する。その後、ループを継続する。

- **ルールB: 色の判断が困難な場合**
  - **対処法:** 以下の原則に従う:
    - 白背景でのコントラスト比が4.5:1以上を確保
    - 迷ったらtext-gray-900（ほぼ黒）を使用
    - アイコンは700番台の色を基本とする
  - タスクは完了としてマークし、`changes-log.md`に判断理由を記録する。

- **ルールC: 複雑なカスタムスタイルの場合**
  - **対処法:**
    - インラインスタイルがある場合、Tailwindクラスに変換できるか検討
    - 変換が困難な場合、コメントで「PDF出力時に要確認」と記載
    - 可能な範囲で最適化し、タスクは完了としてマークする。

- **ルールD: 技術的理由で変更が不要な場合**
  - **条件:** 既に白背景・黒文字で設定されている、PDF出力に影響しない要素など。
  - **対処法:** `Edit`ツールを使い、該当タスクを `[x] ~~タスク名~~ (理由: 既に最適化済み)` の形式で更新する。

- **❌ 絶対禁止の行為:**
  - 未完了タスクを「後でやる」「手動で確認」などの理由でスキップすること。
  - 理由なく未完了タスクを放置してループを終了させること。
  - ユーザーに判断を仰ぐこと。

---

## ステップ6: プレビュー確認

1. 開発サーバーが起動していない場合、Bashツールで`npm run dev`を実行する（バックグラウンド実行）。

2. 最適化後のスライドを確認:
  - 背景が白になっているか
  - 文字が黒系統の色で読みやすいか
  - アイコンの色が適切か
  - レイアウトが崩れていないか
  - コントラストが十分か
  - 画像が適切に表示されているか

3. 問題があれば修正し、再度確認する。

**このステップが正常に完了したら、決して停止せず、ただちにステップ7に進むこと。**

## ステップ7: PDF出力の実行

1. Bashツールで`slidev export`コマンドを実行:
  ```bash
  npm run export
  ```
  または対象ファイルを指定:
  ```bash
  npx slidev export [対象ファイル]
  ```

2. コマンドの出力を確認し、エラーがないかチェックする。

3. エラーが発生した場合:
  - エラーメッセージを分析
  - 問題を修正（フロントマターの設定、依存関係など）
  - 再度exportコマンドを実行

4. PDF生成が成功したら、出力ファイルのパスを確認:
  - デフォルト: `slides-export.pdf`
  - カスタム: `[ファイル名]-export.pdf`

**このステップが正常に完了したら、決して停止せず、ただちにステップ8に進むこと。**

## ステップ8: PDF品質の検証

1. 生成されたPDFファイルについて、以下を確認:
  - [ ] ファイルが正常に生成されているか
  - [ ] ファイルサイズが妥当か（異常に大きい・小さいことはないか）
  - [ ] ページ数が予想通りか（スライド枚数と一致するか）

2. `changes-log.md`にPDF生成結果を記録:
  ```markdown
  ## PDF生成結果

  - 生成日時: [日時]
  - 出力ファイル: [ファイル名]
  - ファイルサイズ: [サイズ]
  - ページ数: [ページ数]
  - 元スライド枚数: [枚数]

  ### 生成時の注意事項
  - [特記事項があれば記載]
  ```

**このステップが正常に完了したら、決して停止せず、ただちにステップ9に進むこと。**

## ステップ9: 振り返りと完了処理

1. `changes-log.md`に全体サマリーを追記:
  ```markdown
  ## 最適化サマリー

  - 対象ファイル: [ファイル名]
  - 最適化開始: [日時]
  - 最適化完了: [日時]

  ### 実施した変更
  - フロントマター変更: [詳細]
  - 文字色変更: [箇所数]
  - 背景色変更: [箇所数]
  - アイコン色変更: [箇所数]
  - レイアウト調整: [箇所数]
  - その他の変更: [詳細]

  ### 生成されたPDF
  - ファイル名: [ファイル名]
  - ページ数: [ページ数]
  - ファイルサイズ: [サイズ]

  ### 品質評価
  - コントラスト: 良好 / 要改善
  - 読みやすさ: 良好 / 要改善
  - レイアウト: 良好 / 要改善
  - 総合評価: 良好 / 要改善

  ### 今後の改善点
  - [改善点のリスト]

  ### 学んだこと
  - [記述]
  ```

2. git commitを実行して、最適化後のファイルとPDFを保存:
  ```bash
  git add [対象ファイル] [PDFファイル] .pdf-planning/
  git commit -m "Optimize for PDF export and generate PDF: [ファイル名]

  Changes:
  - Changed theme to 'default' and background to 'white'
  - Adjusted text colors for better contrast
  - Adjusted icon colors
  - Optimized layout elements

  Generated PDF:
  - File: [PDFファイル名]
  - Pages: [ページ数]

  Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
  ```

3. ユーザーへの完了メッセージを準備:
  ```markdown
  ## PDF出力完了

  スライドのPDF最適化とエクスポートが完了しました。

  ### 生成されたファイル
  - PDF: [PDFファイルパス]
  - ページ数: [ページ数]
  - ファイルサイズ: [サイズ]

  ### 実施した最適化
  - 背景色を白に変更
  - 文字色を黒系統に調整
  - アイコン色を調整
  - レイアウト要素を最適化

  ### バックアップ
  - Git commit: [commit hash]
  - バックアップファイル: [バックアップファイルパス]

  ### 推奨される次のアクション
  1. PDFファイルを開いて品質を確認
  2. 必要に応じて微調整を実施
  3. 印刷テストを実施（可能な場合）
  ```

## 完了条件

このワークフローは、以下の全ての条件を満たした時点で自動的に完了となる。

- ステップ3: バックアップが作成されている（skip-backupオプションが指定されていない場合）。
- ステップ4: 最適化計画が作成されている（export-onlyオプションが指定されていない場合）。
- ステップ5: `tasklist.md`の全てのタスクが完了状態（export-onlyでない場合）。
- ステップ6: プレビュー確認が完了している（export-onlyでない場合）。
- ステップ7: PDF出力が成功し、PDFファイルが生成されている。
- ステップ8: PDF品質が検証されている。
- ステップ9: 変更ログとgit commitが完了している。

この完了条件を満たすまで、自律的に思考し、問題解決を行い、作業を継続すること。

## 補足: 色変換対応表

### 文字色（Text Colors）

| ダークモード用 | ライトモード用 | 用途 |
|--------------|--------------|------|
| text-white | text-black / text-gray-900 | 基本テキスト |
| text-gray-100 | text-gray-900 | 基本テキスト |
| text-gray-200 | text-gray-800 | サブテキスト |
| text-gray-300 | text-gray-700 | サブテキスト |
| text-blue-400 | text-blue-700 | リンク・強調 |
| text-green-400 | text-green-700 | 成功・正の意味 |
| text-red-400 | text-red-700 | エラー・警告 |
| text-yellow-400 | text-yellow-700 | 注意・ハイライト |
| text-purple-400 | text-purple-700 | その他の強調 |

### 背景色（Background Colors）

| ダークモード用 | ライトモード用 | 用途 |
|--------------|--------------|------|
| bg-gray-900 | bg-white / bg-gray-50 | メイン背景 |
| bg-gray-800 | bg-gray-100 | セカンダリ背景 |
| bg-gray-700 | bg-gray-200 | カード背景 |
| bg-blue-900 | bg-blue-50 | 強調背景 |
| bg-green-900 | bg-green-50 | 成功背景 |
| bg-red-900 | bg-red-50 | エラー背景 |

### ボーダー色（Border Colors）

| ダークモード用 | ライトモード用 | 用途 |
|--------------|--------------|------|
| border-gray-700 | border-gray-300 | 基本ボーダー |
| border-gray-600 | border-gray-400 | 目立つボーダー |
| border-blue-500 | border-blue-600 | 強調ボーダー |

## 補足: トラブルシューティング

### PDF生成エラーの対処

1. **"Chromium not found"エラー**
  ```bash
  npx playwright install chromium
  ```

2. **"Out of memory"エラー**
  - スライド枚数が多い場合、分割してエクスポート
  - または Node.js のメモリ制限を増やす:
  ```bash
  NODE_OPTIONS=--max-old-space-size=4096 npm run export
  ```

3. **レイアウト崩れ**
  - フロントマターの設定を確認
  - カスタムCSSが適切か確認
  - ブラウザのプレビューと比較

4. **文字化け**
  - フォント設定を確認
  - 日本語フォントが正しく読み込まれているか確認

### 品質向上のヒント

1. **コントラスト比の確認**
  - WCAG 2.1基準: 通常テキストで4.5:1以上
  - 大きなテキストで3:1以上

2. **印刷テスト**
  - 実際にプリンタで印刷して確認
  - グレースケール印刷でも読みやすいか確認

3. **ファイルサイズの最適化**
  - 画像サイズを適切に調整
  - 不要な高解像度画像を避ける
